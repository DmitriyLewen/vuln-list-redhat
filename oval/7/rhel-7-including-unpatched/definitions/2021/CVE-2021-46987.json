{
  "Class": "vulnerability",
  "ID": "oval:com.redhat.cve:def:202146987",
  "Version": "636",
  "Metadata": {
    "Title": "kernel: btrfs: fix deadlock when cloning inline extents and using qgroups (moderate)",
    "References": [
      {
        "Source": "CVE",
        "RefID": "CVE-2021-46987",
        "RefURL": "https://access.redhat.com/security/cve/CVE-2021-46987"
      }
    ],
    "Description": "DOCUMENTATION: The MITRE CVE dictionary describes this issue as: In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix deadlock when cloning inline extents and using qgroups\n\nThere are a few exceptional cases where cloning an inline extent needs to\ncopy the inline extent data into a page of the destination inode.\n\nWhen this happens, we end up starting a transaction while having a dirty\npage for the destination inode and while having the range locked in the\ndestination's inode iotree too. Because when reserving metadata space\nfor a transaction we may need to flush existing delalloc in case there is\nnot enough free space, we have a mechanism in place to prevent a deadlock,\nwhich was introduced in commit 3d45f221ce627d (\"btrfs: fix deadlock when\ncloning inline extent and low on free metadata space\").\n\nHowever when using qgroups, a transaction also reserves metadata qgroup\nspace, which can also result in flushing delalloc in case there is not\nenough available space at the moment. When this happens we deadlock, since\nflushing delalloc requires locking the file range in the inode's iotree\nand the range was already locked at the very beginning of the clone\noperation, before attempting to start the transaction.\n\nWhen this issue happens, stack traces like the following are reported:\n\n  [72747.556262] task:kworker/u81:9   state:D stack:    0 pid:  225 ppid:     2 flags:0x00004000\n  [72747.556268] Workqueue: writeback wb_workfn (flush-btrfs-1142)\n  [72747.556271] Call Trace:\n  [72747.556273]  __schedule+0x296/0x760\n  [72747.556277]  schedule+0x3c/0xa0\n  [72747.556279]  io_schedule+0x12/0x40\n  [72747.556284]  __lock_page+0x13c/0x280\n  [72747.556287]  ? generic_file_readonly_mmap+0x70/0x70\n  [72747.556325]  extent_write_cache_pages+0x22a/0x440 [btrfs]\n  [72747.556331]  ? __set_page_dirty_nobuffers+0xe7/0x160\n  [72747.556358]  ? set_extent_buffer_dirty+0x5e/0x80 [btrfs]\n  [72747.556362]  ? update_group_capacity+0x25/0x210\n  [72747.556366]  ? cpumask_next_and+0x1a/0x20\n  [72747.556391]  extent_writepages+0x44/0xa0 [btrfs]\n  [72747.556394]  do_writepages+0x41/0xd0\n  [72747.556398]  __writeback_single_inode+0x39/0x2a0\n  [72747.556403]  writeback_sb_inodes+0x1ea/0x440\n  [72747.556407]  __writeback_inodes_wb+0x5f/0xc0\n  [72747.556410]  wb_writeback+0x235/0x2b0\n  [72747.556414]  ? get_nr_inodes+0x35/0x50\n  [72747.556417]  wb_workfn+0x354/0x490\n  [72747.556420]  ? newidle_balance+0x2c5/0x3e0\n  [72747.556424]  process_one_work+0x1aa/0x340\n  [72747.556426]  worker_thread+0x30/0x390\n  [72747.556429]  ? create_worker+0x1a0/0x1a0\n  [72747.556432]  kthread+0x116/0x130\n  [72747.556435]  ? kthread_park+0x80/0x80\n  [72747.556438]  ret_from_fork+0x1f/0x30\n\n  [72747.566958] Workqueue: btrfs-flush_delalloc btrfs_work_helper [btrfs]\n  [72747.566961] Call Trace:\n  [72747.566964]  __schedule+0x296/0x760\n  [72747.566968]  ? finish_wait+0x80/0x80\n  [72747.566970]  schedule+0x3c/0xa0\n  [72747.566995]  wait_extent_bit.constprop.68+0x13b/0x1c0 [btrfs]\n  [72747.566999]  ? finish_wait+0x80/0x80\n  [72747.567024]  lock_extent_bits+0x37/0x90 [btrfs]\n  [72747.567047]  btrfs_invalidatepage+0x299/0x2c0 [btrfs]\n  [72747.567051]  ? find_get_pages_range_tag+0x2cd/0x380\n  [72747.567076]  __extent_writepage+0x203/0x320 [btrfs]\n  [72747.567102]  extent_write_cache_pages+0x2bb/0x440 [btrfs]\n  [72747.567106]  ? update_load_avg+0x7e/0x5f0\n  [72747.567109]  ? enqueue_entity+0xf4/0x6f0\n  [72747.567134]  extent_writepages+0x44/0xa0 [btrfs]\n  [72747.567137]  ? enqueue_task_fair+0x93/0x6f0\n  [72747.567140]  do_writepages+0x41/0xd0\n  [72747.567144]  __filemap_fdatawrite_range+0xc7/0x100\n  [72747.567167]  btrfs_run_delalloc_work+0x17/0x40 [btrfs]\n  [72747.567195]  btrfs_work_helper+0xc2/0x300 [btrfs]\n  [72747.567200]  process_one_work+0x1aa/0x340\n  [72747.567202]  worker_thread+0x30/0x390\n  [72747.567205]  ? create_worker+0x1a0/0x1a0\n  [72747.567208]  kthread+0x116/0x130\n  [72747.567211]  ? kthread_park+0x80/0x80\n  [72747.567214]  ret_from_fork+0x1f/0x30\n\n  [72747.569686] task:fsstress        state:D stack:    \n---truncated--- \n            STATEMENT: Red Hat Enterprise Linux 8 and 9 are not affected by this CVE, as they do not include Btrfs filesystem support (CONFIG_BTRFS_FS is not set).\n            MITIGATION: Mitigation for this issue is either not available or the currently available options do not meet the Red Hat Product Security criteria comprising ease of use and deployment, applicability to widespread installation base or stability.",
    "Advisory": {
      "From": "secalert@redhat.com",
      "Severity": "Moderate",
      "Issued": {},
      "Updated": {
        "Date": "2024-06-18"
      },
      "Cves": [
        {
          "CveID": "CVE-2021-46987",
          "Cvss3": "5.5/CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
          "Cwe": "CWE-833",
          "Impact": "moderate",
          "Href": "https://access.redhat.com/security/cve/CVE-2021-46987",
          "Public": "20240228"
        }
      ],
      "AffectedCpeList": [
        "cpe:/a:redhat:rhel_extras:7",
        "cpe:/a:redhat:rhel_extras_oracle_java:7",
        "cpe:/a:redhat:rhel_extras_rt:7",
        "cpe:/a:redhat:rhel_extras_sap:7",
        "cpe:/a:redhat:rhel_extras_sap_hana:7",
        "cpe:/o:redhat:enterprise_linux:7",
        "cpe:/o:redhat:enterprise_linux:7::client",
        "cpe:/o:redhat:enterprise_linux:7::computenode",
        "cpe:/o:redhat:enterprise_linux:7::server",
        "cpe:/o:redhat:enterprise_linux:7::workstation"
      ],
      "Affected": {
        "Resolution": {
          "State": "Out of support scope"
        }
      }
    }
  },
  "Criteria": {
    "Operator": "OR",
    "Criterions": [
      {
        "Comment": "Red Hat Enterprise Linux must be installed",
        "TestRef": "oval:com.redhat.cve:tst:20042779006"
      }
    ],
    "Criterias": [
      {
        "Operator": "AND",
        "Criterions": [
          {
            "Comment": "Red Hat Enterprise Linux 7 is installed",
            "TestRef": "oval:com.redhat.cve:tst:20042779005"
          }
        ],
        "Criterias": [
          {
            "Operator": "OR",
            "Criterias": [
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542029"
                  },
                  {
                    "Comment": "kernel-tools-libs is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542030"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542005"
                  },
                  {
                    "Comment": "kernel-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542006"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "python-perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542021"
                  },
                  {
                    "Comment": "python-perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446021"
                  },
                  {
                    "Comment": "kernel-rt-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542027"
                  },
                  {
                    "Comment": "kernel-tools is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-bootwrapper is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542013"
                  },
                  {
                    "Comment": "kernel-bootwrapper is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542014"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446051"
                  },
                  {
                    "Comment": "kernel-rt-trace is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446052"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446031"
                  },
                  {
                    "Comment": "kernel-rt-trace-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446032"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542015"
                  },
                  {
                    "Comment": "kernel-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542007"
                  },
                  {
                    "Comment": "kernel-kdump is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542008"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542001"
                  },
                  {
                    "Comment": "kernel-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542002"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "bpftool is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542009"
                  },
                  {
                    "Comment": "bpftool is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446027"
                  },
                  {
                    "Comment": "kernel-rt is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446009"
                  },
                  {
                    "Comment": "kernel-rt-debug-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542017"
                  },
                  {
                    "Comment": "kernel-tools-libs-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542011"
                  },
                  {
                    "Comment": "perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542012"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446001"
                  },
                  {
                    "Comment": "kernel-rt-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446002"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542025"
                  },
                  {
                    "Comment": "kernel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542026"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446045"
                  },
                  {
                    "Comment": "kernel-rt-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446046"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-headers is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542031"
                  },
                  {
                    "Comment": "kernel-headers is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542032"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542019"
                  },
                  {
                    "Comment": "kernel-kdump-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542020"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446043"
                  },
                  {
                    "Comment": "kernel-rt-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446044"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-abi-whitelists is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542023"
                  },
                  {
                    "Comment": "kernel-abi-whitelists is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542024"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446015"
                  },
                  {
                    "Comment": "kernel-rt-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542003"
                  },
                  {
                    "Comment": "kernel-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542004"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446017"
                  },
                  {
                    "Comment": "kernel-rt-trace-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446018"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}