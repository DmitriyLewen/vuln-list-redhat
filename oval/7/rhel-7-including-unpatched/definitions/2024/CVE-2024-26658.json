{
  "Class": "vulnerability",
  "ID": "oval:com.redhat.cve:def:202426658",
  "Version": "636",
  "Metadata": {
    "Title": "kernel: bcachefs: grab s_umount only if snapshotting (moderate)",
    "References": [
      {
        "Source": "CVE",
        "RefID": "CVE-2024-26658",
        "RefURL": "https://access.redhat.com/security/cve/CVE-2024-26658"
      }
    ],
    "Description": "DOCUMENTATION: The MITRE CVE dictionary describes this issue as: In the Linux kernel, the following vulnerability has been resolved:\n\nbcachefs: grab s_umount only if snapshotting\n\nWhen I was testing mongodb over bcachefs with compression,\nthere is a lockdep warning when snapshotting mongodb data volume.\n\n$ cat test.sh\nprog=bcachefs\n\n$prog subvolume create /mnt/data\n$prog subvolume create /mnt/data/snapshots\n\nwhile true;do\n    $prog subvolume snapshot /mnt/data /mnt/data/snapshots/$(date +%s)\n    sleep 1s\ndone\n\n$ cat /etc/mongodb.conf\nsystemLog:\n  destination: file\n  logAppend: true\n  path: /mnt/data/mongod.log\n\nstorage:\n  dbPath: /mnt/data/\n\nlockdep reports:\n[ 3437.452330] ======================================================\n[ 3437.452750] WARNING: possible circular locking dependency detected\n[ 3437.453168] 6.7.0-rc7-custom+ #85 Tainted: G            E\n[ 3437.453562] ------------------------------------------------------\n[ 3437.453981] bcachefs/35533 is trying to acquire lock:\n[ 3437.454325] ffffa0a02b2b1418 (sb_writers#10){.+.+}-{0:0}, at: filename_create+0x62/0x190\n[ 3437.454875]\n               but task is already holding lock:\n[ 3437.455268] ffffa0a02b2b10e0 (\u0026type-\u003es_umount_key#48){.+.+}-{3:3}, at: bch2_fs_file_ioctl+0x232/0xc90 [bcachefs]\n[ 3437.456009]\n               which lock already depends on the new lock.\n\n[ 3437.456553]\n               the existing dependency chain (in reverse order) is:\n[ 3437.457054]\n               -\u003e #3 (\u0026type-\u003es_umount_key#48){.+.+}-{3:3}:\n[ 3437.457507]        down_read+0x3e/0x170\n[ 3437.457772]        bch2_fs_file_ioctl+0x232/0xc90 [bcachefs]\n[ 3437.458206]        __x64_sys_ioctl+0x93/0xd0\n[ 3437.458498]        do_syscall_64+0x42/0xf0\n[ 3437.458779]        entry_SYSCALL_64_after_hwframe+0x6e/0x76\n[ 3437.459155]\n               -\u003e #2 (\u0026c-\u003esnapshot_create_lock){++++}-{3:3}:\n[ 3437.459615]        down_read+0x3e/0x170\n[ 3437.459878]        bch2_truncate+0x82/0x110 [bcachefs]\n[ 3437.460276]        bchfs_truncate+0x254/0x3c0 [bcachefs]\n[ 3437.460686]        notify_change+0x1f1/0x4a0\n[ 3437.461283]        do_truncate+0x7f/0xd0\n[ 3437.461555]        path_openat+0xa57/0xce0\n[ 3437.461836]        do_filp_open+0xb4/0x160\n[ 3437.462116]        do_sys_openat2+0x91/0xc0\n[ 3437.462402]        __x64_sys_openat+0x53/0xa0\n[ 3437.462701]        do_syscall_64+0x42/0xf0\n[ 3437.462982]        entry_SYSCALL_64_after_hwframe+0x6e/0x76\n[ 3437.463359]\n               -\u003e #1 (\u0026sb-\u003es_type-\u003ei_mutex_key#15){+.+.}-{3:3}:\n[ 3437.463843]        down_write+0x3b/0xc0\n[ 3437.464223]        bch2_write_iter+0x5b/0xcc0 [bcachefs]\n[ 3437.464493]        vfs_write+0x21b/0x4c0\n[ 3437.464653]        ksys_write+0x69/0xf0\n[ 3437.464839]        do_syscall_64+0x42/0xf0\n[ 3437.465009]        entry_SYSCALL_64_after_hwframe+0x6e/0x76\n[ 3437.465231]\n               -\u003e #0 (sb_writers#10){.+.+}-{0:0}:\n[ 3437.465471]        __lock_acquire+0x1455/0x21b0\n[ 3437.465656]        lock_acquire+0xc6/0x2b0\n[ 3437.465822]        mnt_want_write+0x46/0x1a0\n[ 3437.465996]        filename_create+0x62/0x190\n[ 3437.466175]        user_path_create+0x2d/0x50\n[ 3437.466352]        bch2_fs_file_ioctl+0x2ec/0xc90 [bcachefs]\n[ 3437.466617]        __x64_sys_ioctl+0x93/0xd0\n[ 3437.466791]        do_syscall_64+0x42/0xf0\n[ 3437.466957]        entry_SYSCALL_64_after_hwframe+0x6e/0x76\n[ 3437.467180]\n               other info that might help us debug this:\n\n[ 3437.469670] 2 locks held by bcachefs/35533:\n               other info that might help us debug this:\n\n[ 3437.467507] Chain exists of:\n                 sb_writers#10 --\u003e \u0026c-\u003esnapshot_create_lock --\u003e \u0026type-\u003es_umount_key#48\n\n[ 3437.467979]  Possible unsafe locking scenario:\n\n[ 3437.468223]        CPU0                    CPU1\n[ 3437.468405]        ----                    ----\n[ 3437.468585]   rlock(\u0026type-\u003es_umount_key#48);\n[ 3437.468758]                                lock(\u0026c-\u003esnapshot_create_lock);\n[ 3437.469030]                                lock(\u0026type-\u003es_umount_key#48);\n[ 3437.469291]   rlock(sb_writers#10);\n[ 3437.469434]\n                *** DEADLOCK ***\n\n[ 3437.469\n---truncated---",
    "Advisory": {
      "From": "secalert@redhat.com",
      "Severity": "Moderate",
      "Issued": {},
      "Updated": {
        "Date": "2024-04-02"
      },
      "Cves": [
        {
          "CveID": "CVE-2024-26658",
          "Cvss3": "5.5/CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
          "Impact": "moderate",
          "Href": "https://access.redhat.com/security/cve/CVE-2024-26658",
          "Public": "20240402"
        }
      ],
      "AffectedCpeList": [
        "cpe:/a:redhat:rhel_extras:7",
        "cpe:/a:redhat:rhel_extras_oracle_java:7",
        "cpe:/a:redhat:rhel_extras_rt:7",
        "cpe:/a:redhat:rhel_extras_sap:7",
        "cpe:/a:redhat:rhel_extras_sap_hana:7",
        "cpe:/o:redhat:enterprise_linux:7",
        "cpe:/o:redhat:enterprise_linux:7::client",
        "cpe:/o:redhat:enterprise_linux:7::computenode",
        "cpe:/o:redhat:enterprise_linux:7::server",
        "cpe:/o:redhat:enterprise_linux:7::workstation"
      ],
      "Affected": {
        "Resolution": {
          "State": "Out of support scope"
        }
      }
    }
  },
  "Criteria": {
    "Operator": "OR",
    "Criterions": [
      {
        "Comment": "Red Hat Enterprise Linux must be installed",
        "TestRef": "oval:com.redhat.cve:tst:20042779006"
      }
    ],
    "Criterias": [
      {
        "Operator": "AND",
        "Criterions": [
          {
            "Comment": "Red Hat Enterprise Linux 7 is installed",
            "TestRef": "oval:com.redhat.cve:tst:20042779005"
          }
        ],
        "Criterias": [
          {
            "Operator": "OR",
            "Criterias": [
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542029"
                  },
                  {
                    "Comment": "kernel-tools-libs is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542030"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "bpftool is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542009"
                  },
                  {
                    "Comment": "bpftool is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542015"
                  },
                  {
                    "Comment": "kernel-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542007"
                  },
                  {
                    "Comment": "kernel-kdump is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542008"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-kdump-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542019"
                  },
                  {
                    "Comment": "kernel-kdump-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542020"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446043"
                  },
                  {
                    "Comment": "kernel-rt-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446044"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542003"
                  },
                  {
                    "Comment": "kernel-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542004"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542027"
                  },
                  {
                    "Comment": "kernel-tools is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446001"
                  },
                  {
                    "Comment": "kernel-rt-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446002"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446051"
                  },
                  {
                    "Comment": "kernel-rt-trace is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446052"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542011"
                  },
                  {
                    "Comment": "perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542012"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-doc is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542005"
                  },
                  {
                    "Comment": "kernel-doc is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542006"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446045"
                  },
                  {
                    "Comment": "kernel-rt-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446046"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446021"
                  },
                  {
                    "Comment": "kernel-rt-debug is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542025"
                  },
                  {
                    "Comment": "kernel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542026"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-debug-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446009"
                  },
                  {
                    "Comment": "kernel-rt-debug-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446010"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-abi-whitelists is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542023"
                  },
                  {
                    "Comment": "kernel-abi-whitelists is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542024"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-bootwrapper is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542013"
                  },
                  {
                    "Comment": "kernel-bootwrapper is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542014"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446031"
                  },
                  {
                    "Comment": "kernel-rt-trace-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446032"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-trace-kvm is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446017"
                  },
                  {
                    "Comment": "kernel-rt-trace-kvm is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-headers is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542031"
                  },
                  {
                    "Comment": "kernel-headers is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542032"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-tools-libs-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542017"
                  },
                  {
                    "Comment": "kernel-tools-libs-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542018"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "python-perf is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542021"
                  },
                  {
                    "Comment": "python-perf is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542022"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446015"
                  },
                  {
                    "Comment": "kernel-rt-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446016"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-rt is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20137446027"
                  },
                  {
                    "Comment": "kernel-rt is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20137446028"
                  }
                ]
              },
              {
                "Operator": "AND",
                "Criterions": [
                  {
                    "Comment": "kernel-debug-devel is installed",
                    "TestRef": "oval:com.redhat.cve:tst:20124542001"
                  },
                  {
                    "Comment": "kernel-debug-devel is signed with Red Hat redhatrelease2 key",
                    "TestRef": "oval:com.redhat.cve:tst:20124542002"
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}